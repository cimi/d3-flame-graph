(function(){var t;if(t=window.d3,!t)throw new Error("d3.js needs to be loaded");t.flameGraph=function(){var n,e,r;return e=function(t){var n;return n=t.split("."),n.slice(n.length-2).join(".")},r=function(t){var n,r,i,o,a,s,u,h;for(a=[0,0,1,10],u=a[0],i=a[1],h=a[2],o=a[3],t=e(t).slice(0,6),n=r=0,s=t.length-1;s>=0?s>=r:r>=s;n=s>=0?++r:--r)u+=h*(t.charCodeAt(n)%o),i+=h*(o-1),h*=.7;return i>0?u/i:u},new(n=function(){function n(){this._generateAccessors(["size","margin","cellHeight","breadcrumbs","tooltip","color"]),this._allData=[],this._size=[1200,800],this._cellHeight=10,this._margin={top:0,right:0,bottom:0,left:0},this._color=function(t){var n,e,i,o;return o=r(t.name),i=200+Math.round(55*o),e=0+Math.round(230*(1-o)),n=0+Math.round(55*(1-o)),"rgb("+i+", "+e+", "+n+")"}}return n.prototype.data=function(n){return n?(this._allData.push(n),this.totalSamples=n.samples,this._data=t.layout.partition().sort(function(t,n){return t.name?n.name?t.name.localeCompare(n.name):-1:1}).nodes(n),this):this._data},n.prototype.width=function(){return this.size()[0]-(this.margin().left+this.margin().right)},n.prototype.height=function(){return this.size()[1]-(this.margin().top+this.margin().bottom)},n.prototype.label=function(t){var n;return(null!=t?t.name:void 0)?(n=e(t.name),n.substr(0,Math.round(this.x(t.dx)/4))):""},n.prototype.render=function(n){var e;return console.time("render"),this._selector=n,t.select(n).select("svg").remove(),this.container=t.select(n).append("svg").attr("class","flame-graph").attr("width",this.size()[0]).attr("height",this.size()[1]).append("g").attr("transform","translate("+this.margin().left+", "+this.margin().top+")"),this.maxCells=Math.floor(this.height()/this.cellHeight()),this.maxDepth=this.data()[0].maxDepth,this.x=t.scale.linear().domain([0,t.max(this.data(),function(t){return t.x+t.dx})]).range([0,this.width()]),this.y=t.scale.quantize().domain([t.max(this.data(),function(t){return t.y}),0]).range(t.range(this.maxDepth).map(function(t){return function(n){return(n-t.maxDepth+t.maxCells)*t.cellHeight()}}(this))),e=this.container.selectAll(".node").data(this.data().filter(function(t){return function(n){return t.x(n.dx)>.1&&t.y(n.y)>=0&&!n.filler}}(this))).enter().append("g").attr("class","node"),e.append("rect").attr("width",function(t){return function(n){return t.x(n.dx)}}(this)).attr("height",function(t){return function(n){return t.cellHeight()}}(this)).attr("x",function(t){return function(n){return t.x(n.x)}}(this)).attr("y",function(t){return function(n){return t.y(n.y)}}(this)).attr("fill",function(t){return function(n){return t.color()(n)}}(this)),e.append("text").attr("class","label").attr("width",function(t){return function(n){return t.x(n.dx)}}(this)).attr("dy",".25em").attr("x",function(t){return function(n){return t.x(n.x)+2}}(this)).attr("y",function(t){return function(n){return t.y(n.y)+t.cellHeight()/2}}(this)).text(function(t){return function(n){return n.name&&t.x(n.dx)>40?t.label(n):void 0}}(this)),e.append("rect").attr("width",function(t){return function(n){return t.x(n.dx)}}(this)).attr("height",function(t){return function(n){return t.cellHeight()}}(this)).attr("x",function(t){return function(n){return t.x(n.x)}}(this)).attr("y",function(t){return function(n){return t.y(n.y)}}(this)).attr("opacity",0),console.timeEnd("render"),console.log("Rendered "+this.container.selectAll(".node")[0].length+" elements"),this.breadcrumbs()&&this._enableNavigation()._renderBreadcrumbs(),this.tooltip()&&this._renderTooltip(),this},n.prototype._renderTooltip=function(){return this.tip=t.tip().attr("class","d3-tip").html(function(t){return function(n){return n.name+" <br /><br />"+n.totalTime+" run time<br />"+(n.samples/t.totalSamples*100).toFixed(2)+"% of total"}}(this)).direction(function(t){return function(n){return t.x(n.x)+t.x(n.dx)/2>t.width()-100?"w":t.x(n.x)+t.x(n.dx)/2<100?"e":t.y(n.y)<100?"s":"n"}}(this)).offset(function(t){return function(n){var e,r,i;return e=t.x(n.x)+t.x(n.dx)/2,r=t.x(n.dx)/2,i=t.cellHeight()/2,t.width()-100<e?[0,-r]:100>e?[0,r]:t.y(n.y)<100?[i,0]:[-i,0]}}(this)),this.container.call(this.tip),this.container.selectAll(".node").on("mouseover",function(n){return function(e){return console.log(e,t.event),t.event.stopPropagation(),n.tip.show(e)}}(this)).on("mouseout",this.tip.hide),this},n.prototype._renderBreadcrumbs=function(){var n,r;return n=this._allData.map(function(t,n){return{name:t.name,value:n}}),r=t.select(this.breadcrumbs()).selectAll("li").data(n),r.enter().append("li").append("a").attr("title",function(t){return t.name}).text(function(t){return e(t.name)}).on("click",function(t){return function(n){var e,r;return r=n.value,e=t._allData[r],t._allData=t._allData.slice(0,r),t.data(e).render(t._selector)}}(this)),r.exit().remove(),this},n.prototype._enableNavigation=function(){return this.container.selectAll(".node").on("click",function(n){return function(e){return t.event.stopPropagation(),n.data(e).render(n._selector)}}(this)),this},n.prototype._generateAccessors=function(t){var n,e,r,i;for(i=[],e=0,r=t.length;r>e;e++)n=t[e],i.push(this[n]=function(t){return function(n){return arguments.length?(this["_"+t]=n,this):this["_"+t]}}(n));return i},n}())}}).call(this);