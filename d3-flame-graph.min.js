(function(){var t,e=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};if(t=this.d3?this.d3:require("d3"),!t)throw new Error("d3.js needs to be loaded");t.flameGraph=function(){var n,i,r,o,s;return r=function(t){var e;return e=t.split("."),e.slice(e.length-2).join(".")},o=function(t){var e,n,i,o,s,h,a,l;for(s=[0,0,1,10],a=s[0],i=s[1],l=s[2],o=s[3],t=r(t).slice(0,6),e=n=0,h=t.length-1;h>=0?h>=n:n>=h;e=h>=0?++n:--n)a+=l*(t.charCodeAt(e)%o),i+=l*(o-1),l*=.7;return i>0?a/i:a},i=function(t){var e,n;return n=t.children,t.level||(t.level=1),t.augmented?t:(null!=n?n.length:void 0)?(e=n.reduce(function(t,e){return t+e.value},0),e<t.value&&n.push({value:t.value-e,filler:!0}),n.forEach(i),t.level+=n.map(function(t){return t.level}).reduce(function(t,e){return e>t?e:t},0),t.augmented=!0,t):(t.augmented=!0,t)},s=function(e){return t.layout.partition().sort(function(t,e){return t.filler?1:e.filler?-1:t.name.localeCompare(e.name)}).nodes(e)},new(n=function(){function n(){this._generateAccessors(["size","margin","cellHeight","zoomEnabled","zoomAction","tooltip","color"]),this._ancestors=[],this._size=[1200,800],this._cellHeight=10,this._margin={top:0,right:0,bottom:0,left:0},this._color=function(t){var e,n,i,r;return r=o(t.name),i=200+Math.round(55*r),n=0+Math.round(230*(1-r)),e=0+Math.round(55*(1-r)),"rgb("+i+", "+n+", "+e+")"},this._tooltipEnabled=!0,this._zoomEnabled=!0}return n.prototype.data=function(t){return t?(console.time("augment"),t=i(t),console.timeEnd("augment"),this.original||(this.original=t),console.time("partition"),this._data=s(t),console.timeEnd("partition"),this):this._data},n.prototype.zoom=function(t){if(!this.zoomEnabled())throw new Error("Zoom is disabled!");return this.tip.hide(),e.call(this._ancestors,t)>=0?this._ancestors=this._ancestors.slice(0,this._ancestors.indexOf(t)):this._ancestors.push(this.data()[0]),this.data(t).render(this._selector),"function"==typeof this._zoomAction&&this._zoomAction(t),this},n.prototype.width=function(){return this.size()[0]-(this.margin().left+this.margin().right)},n.prototype.height=function(){return this.size()[1]-(this.margin().top+this.margin().bottom)},n.prototype.label=function(t){var e;return(null!=t?t.name:void 0)?(e=r(t.name),e.substr(0,Math.round(this.x(t.dx)/(this.cellHeight()/10*4)))):""},n.prototype.select=function(t,e){var n;return null==e&&(e=!0),e?this.container.selectAll(".node").filter(function(e){return t.test(e.name)}):n=s(this.original).filter(function(e){return t.test(e.name)})},n.prototype.render=function(e){var n,i;if(!this._selector&&!e)throw new Error("The container's selector needs to be provided before rendering");return console.time("render"),e&&(this._selector=e),t.select(e).select("svg").remove(),this.container=t.select(e).append("svg").attr("class","flame-graph").attr("width",this.size()[0]).attr("height",this.size()[1]).append("g").attr("transform","translate("+this.margin().left+", "+this.margin().top+")"),this.maxCells=Math.floor(this.height()/this.cellHeight()),this.maxDepth=this.data()[0].level,this.fontSize=this.cellHeight()/10*.4,this.x=t.scale.linear().domain([0,t.max(this.data(),function(t){return t.x+t.dx})]).range([0,this.width()]),this.y=t.scale.quantize().domain([t.max(this.data(),function(t){return t.y}),0]).range(t.range(this.maxDepth).map(function(t){return function(e){return(e-t.maxDepth+t.maxCells-t._ancestors.length)*t.cellHeight()}}(this))),n=this.container.selectAll(".node").data(this.data().filter(function(t){return function(e){return t.x(e.dx)>.4&&t.y(e.y)>=0&&!e.filler}}(this))).enter().append("g").attr("class",function(t,e){return 0===e?"root node":"node"}),this._renderNodes(n,{x:function(t){return function(e){return t.x(e.x)}}(this),y:function(t){return function(e){return t.y(e.y)}}(this),width:function(t){return function(e){return t.x(e.dx)}}(this),height:function(t){return function(e){return t.cellHeight()}}(this),text:function(t){return function(e){return e.name&&t.x(e.dx)>40?t.label(e):void 0}}(this)}),console.timeEnd("render"),console.log("Processed "+this.data().length+" items"),console.log("Rendered "+(null!=(i=this.container.selectAll(".node")[0])?i.length:void 0)+" elements"),this.zoomEnabled()&&this._renderAncestors()._enableNavigation(),this.tooltip()&&this._renderTooltip(),this},n.prototype._renderNodes=function(t,e){return t.append("rect").attr("width",e.width).attr("height",this.cellHeight()).attr("x",e.x).attr("y",e.y).attr("fill",function(t){return function(e){return t.color()(e)}}(this)),t.append("text").attr("class","label").attr("dy",this.fontSize/2+"em").attr("x",function(t){return function(t){return e.x(t)+2}}(this)).attr("y",function(t){return function(n,i){return e.y(n,i)+t.cellHeight()/2}}(this)).style("font-size",this.fontSize+"em").text(e.text),this},n.prototype._renderTooltip=function(){return this.tip=t.tip().attr("class","d3-tip").html(this.tooltip()).direction(function(t){return function(e){return t.x(e.x)+t.x(e.dx)/2>t.width()-100?"w":t.x(e.x)+t.x(e.dx)/2<100?"e":"s"}}(this)).offset(function(t){return function(e){var n,i,r;return n=t.x(e.x)+t.x(e.dx)/2,i=Math.max(Math.ceil(t.x(e.dx)/2),5),r=Math.ceil(t.cellHeight()/2),t.width()-100<n?[0,-i]:100>n?[0,i]:[r,0]}}(this)),this.container.call(this.tip),this.container.selectAll(".node").on("mouseover",this.tip.show).on("mouseout",this.tip.hide),this},n.prototype._renderAncestors=function(){var t,e,n;return t=this._ancestors.map(function(t,e){return{name:t.name,value:e}}),e=this.container.selectAll(".ancestor").data(t),n=e.enter().append("g").attr("class","ancestor"),this._renderNodes(n,{x:function(t){return function(t){return 0}}(this),y:function(t){return function(e,n){return t.height()-(n+1)*t.cellHeight()}}(this),width:this.width(),height:this.cellHeight(),text:function(t){return function(t){return"â†© "+r(t.name)}}(this)}),this},n.prototype._enableNavigation=function(){return this.container.selectAll(".node").on("click",function(e){return function(n,i){return t.event.stopPropagation(),i>0?e.zoom(n):void 0}}(this)),this.container.selectAll(".ancestor").on("click",function(e){return function(n,i){return t.event.stopPropagation(),e.zoom(e._ancestors[i])}}(this)),this},n.prototype._generateAccessors=function(t){var e,n,i,r;for(r=[],n=0,i=t.length;i>n;n++)e=t[n],r.push(this[e]=function(t){return function(e){return arguments.length?(this["_"+t]=e,this):this["_"+t]}}(e));return r},n}())}}).call(this);