(function(){var t;if(t=window.d3,!t)throw new Error("d3.js needs to be loaded");t.flameGraph=function(){var e,n,r,i;return n=function(t){var e;return e=t.split("."),e.slice(e.length-2).join(".")},r=function(t){var e,r,i,o,a,s,u,l;for(a=[0,0,1,10],u=a[0],i=a[1],l=a[2],o=a[3],t=n(t).slice(0,6),e=r=0,s=t.length-1;s>=0?s>=r:r>=s;e=s>=0?++r:--r)u+=l*(t.charCodeAt(e)%o),i+=l*(o-1),l*=.7;return i>0?u/i:u},i=function(e){return t.layout.partition().sort(function(t,e){return t.name?e.name?t.name.localeCompare(e.name):-1:1}).nodes(e)},new(e=function(){function e(){this._generateAccessors(["size","margin","cellHeight","breadcrumbs","tooltip","color"]),this._allData=[],this._size=[1200,800],this._cellHeight=10,this._margin={top:0,right:0,bottom:0,left:0},this._color=function(t){var e,n,i,o;return o=r(t.name),i=200+Math.round(55*o),n=0+Math.round(230*(1-o)),e=0+Math.round(55*(1-o)),"rgb("+i+", "+n+", "+e+")"}}return e.prototype.data=function(t){return t?(this._allData.push(t),this.total=t.value,this._data=i(t),this):this._data},e.prototype.width=function(){return this.size()[0]-(this.margin().left+this.margin().right)},e.prototype.height=function(){return this.size()[1]-(this.margin().top+this.margin().bottom)},e.prototype.label=function(t){var e;return(null!=t?t.name:void 0)?(e=n(t.name),e.substr(0,Math.round(this.x(t.dx)/(this.cellHeight()/10*4)))):""},e.prototype.select=function(t,e){var n;return null==e&&(e=!0),e?this.container.selectAll(".node").filter(function(e){return t.test(e.name)}):(n=i(this._allData[0]).filter(function(e){return t.test(e.name)}),console.log(n),n)},e.prototype.render=function(e){var n,r;if(!this._selector&&!e)throw new Error("The container's selector needs to be provided before rendering");return console.time("render"),e&&(this._selector=e),t.select(e).select("svg").remove(),this.container=t.select(e).append("svg").attr("class","flame-graph").attr("width",this.size()[0]).attr("height",this.size()[1]).append("g").attr("transform","translate("+this.margin().left+", "+this.margin().top+")"),this.maxCells=Math.floor(this.height()/this.cellHeight()),this.maxDepth=this.data()[0].maxDepth,this.x=t.scale.linear().domain([0,t.max(this.data(),function(t){return t.x+t.dx})]).range([0,this.width()]),this.y=t.scale.quantize().domain([t.max(this.data(),function(t){return t.y}),0]).range(t.range(this.maxDepth).map(function(t){return function(e){return(e-t.maxDepth+t.maxCells)*t.cellHeight()}}(this))),n=this.container.selectAll(".node").data(this.data().filter(function(t){return function(e){return t.x(e.dx)>.1&&t.y(e.y)>=0&&!e.filler}}(this))).enter().append("g").attr("class","node"),n.append("rect").attr("width",function(t){return function(e){return t.x(e.dx)}}(this)).attr("height",function(t){return function(e){return t.cellHeight()}}(this)).attr("x",function(t){return function(e){return t.x(e.x)}}(this)).attr("y",function(t){return function(e){return t.y(e.y)}}(this)).attr("fill",function(t){return function(e){return t.color()(e)}}(this)),n.append("text").attr("class","label").attr("dy",".25em").attr("x",function(t){return function(e){return t.x(e.x)+2}}(this)).attr("y",function(t){return function(e){return t.y(e.y)+t.cellHeight()/2}}(this)).style("font-size",this.cellHeight()/10*.4+"em").text(function(t){return function(e){return e.name&&t.x(e.dx)>40?t.label(e):void 0}}(this)),n.append("rect").attr("class","overlay").attr("width",function(t){return function(e){return t.x(e.dx)}}(this)).attr("height",function(t){return function(e){return t.cellHeight()}}(this)).attr("x",function(t){return function(e){return t.x(e.x)}}(this)).attr("y",function(t){return function(e){return t.y(e.y)}}(this)),console.timeEnd("render"),console.log("Rendered "+(null!=(r=this.container.selectAll(".node")[0])?r.length:void 0)+" elements"),this.breadcrumbs()&&this._enableNavigation()._renderBreadcrumbs(),this.tooltip()&&this._renderTooltip(),this},e.prototype._renderTooltip=function(){return this.tip=t.tip().attr("class","d3-tip").html(function(t){return function(e){return e.name+" <br /><br />"+e.time+" run time<br />"+(e.value/t.total*100).toFixed(2)+"% of total"}}(this)).direction(function(t){return function(e){return t.x(e.x)+t.x(e.dx)/2>t.width()-100?"w":t.x(e.x)+t.x(e.dx)/2<100?"e":"s"}}(this)).offset(function(t){return function(e){var n,r,i;return n=t.x(e.x)+t.x(e.dx)/2,r=Math.max(Math.ceil(t.x(e.dx)/2),5),i=Math.ceil(t.cellHeight()/2),t.width()-100<n?[0,-r]:100>n?[0,r]:[i,0]}}(this)),this.container.call(this.tip),this.container.selectAll(".node").on("mouseover",this.tip.show).on("mouseout",this.tip.hide),this},e.prototype._renderBreadcrumbs=function(){var e,r;return e=this._allData.map(function(t,e){return{name:t.name,value:e}}),r=t.select(this.breadcrumbs()).selectAll("li").data(e),r.enter().append("li").append("a").attr("title",function(t){return t.name}).text(function(t){return n(t.name)}).on("click",function(t){return function(e){var n,r;return r=e.value,n=t._allData[r],t._allData=t._allData.slice(0,r),t.data(n).render(t._selector)}}(this)),r.exit().remove(),this},e.prototype._enableNavigation=function(){return this.container.selectAll(".node").on("click",function(e){return function(n){return t.event.stopPropagation(),e.data(n).render(e._selector)}}(this)),this},e.prototype._generateAccessors=function(t){var e,n,r,i;for(i=[],n=0,r=t.length;r>n;n++)e=t[n],i.push(this[e]=function(t){return function(e){return arguments.length?(this["_"+t]=e,this):this["_"+t]}}(e));return i},e}())}}).call(this);